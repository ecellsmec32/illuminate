<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Activity Logs - QrFlow Admin</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        display: ["Inter"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="../assets/css/qrflow.css" rel="stylesheet"/>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-background-light dark:bg-background-dark border-r border-slate-200 dark:border-slate-800 flex flex-col">
            <div class="p-6">
                <h1 class="text-xl font-bold text-slate-800 dark:text-white">
                    QrFlow Admin
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                    System Management
                </p>
            </div>
            <nav class="flex-1 px-4 py-2">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800" href="dashboard.html">
                    <span class="material-symbols-outlined text-2xl"> dashboard </span>
                    <span>Dashboard</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800" href="clubs.html">
                    <span class="material-symbols-outlined text-2xl"> business </span>
                    <span>Clubs</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800" href="users.html">
                    <span class="material-symbols-outlined text-2xl"> group </span>
                    <span>Users</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary font-semibold" href="#">
                    <span class="material-symbols-outlined text-2xl"> history </span>
                    <span>Logs</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800" href="club-admin.html">
                    <span class="material-symbols-outlined text-2xl"> admin_panel_settings </span>
                    <span>Club Admin</span>
                </a>
            </nav>
            <div class="p-4">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800" href="#" onclick="toggleDarkMode()">
                    <span class="material-symbols-outlined text-2xl" id="darkModeIcon"> dark_mode </span>
                    <span id="darkModeText">Dark Mode</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800" href="#" onclick="logout()">
                    <span class="material-symbols-outlined text-2xl"> logout </span>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <header class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-white">
                            Activity Logs
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400">
                            Monitor system activities and user actions
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button class="flex items-center justify-center rounded-lg h-10 px-6 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-white text-sm font-bold shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700" onclick="refreshLogs()">
                            <span class="material-symbols-outlined text-lg mr-2"> refresh </span>
                            Refresh
                        </button>
                        <button class="flex items-center justify-center rounded-lg h-10 px-6 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-white text-sm font-bold shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700" onclick="exportLogs()">
                            <span class="material-symbols-outlined text-lg mr-2"> download </span>
                            Export
                        </button>
                    </div>
                </div>
            </header>

            <!-- Filters -->
            <div class="mb-6">
                <div class="bg-white dark:bg-background-dark border border-slate-200 dark:border-slate-800 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Action Type</label>
                            <select id="actionFilter" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                                <option value="">All Actions</option>
                                <option value="create">Create</option>
                                <option value="update">Update</option>
                                <option value="delete">Delete</option>
                                <option value="login">Login</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">User</label>
                            <select id="userFilter" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Date From</label>
                            <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Date To</label>
                            <input type="date" id="dateTo" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="applyFilters()" class="flex items-center justify-center rounded-lg h-10 px-6 bg-primary text-white text-sm font-bold shadow-sm hover:bg-primary/90">
                            <span class="material-symbols-outlined text-lg mr-2"> filter_list </span>
                            Apply Filters
                        </button>
                        <button onclick="clearFilters()" class="flex items-center justify-center rounded-lg h-10 px-6 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-white text-sm font-bold shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700">
                            <span class="material-symbols-outlined text-lg mr-2"> clear </span>
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Logs Table -->
            <div class="bg-white dark:bg-background-dark border border-slate-200 dark:border-slate-800 rounded-lg">
                <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-800">
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
                        System Activity Logs
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800">
                            <tr>
                                <th class="px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                    User
                                </th>
                                <th class="px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                    Action
                                </th>
                                <th class="px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                    Entity
                                </th>
                                <th class="px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                    Description
                                </th>
                                <th class="px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                    Timestamp
                                </th>
                                <th class="px-6 py-3 text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                    IP Address
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-800" id="logsTable">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-slate-500 dark:text-slate-400">
                                    <div class="flex items-center justify-center">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                                        <span class="ml-2">Loading logs...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="mt-6 flex justify-between items-center">
                <div class="text-sm text-slate-500 dark:text-slate-400">
                    Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalLogs">0</span> logs
                </div>
                <div class="flex gap-2">
                    <button id="prevPage" onclick="changePage(-1)" class="px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-700 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <span id="currentPage" class="px-3 py-2 text-sm text-slate-700 dark:text-slate-300">1</span>
                    <button id="nextPage" onclick="changePage(1)" class="px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-700 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/utils.js"></script>
    
    <script>
        // Check authentication
        Auth.requireAuth();
        const user = Auth.getCurrentUser();
        
        if (user.role !== 'admin') {
            Utils.showToast('Access denied - Admin only', 'error');
            setTimeout(() => window.location.href = '../organizer/dashboard.html', 2000);
        }

        let currentPage = 1;
        const logsPerPage = 20;
        let totalLogs = 0;
        let allLogs = [];

        // Load logs data
        document.addEventListener('DOMContentLoaded', async () => {
            initDarkMode();
            await loadUsers();
            await loadLogs();
        });

        async function loadUsers() {
            try {
                const users = await api.get('/api/admin/users');
                const userSelect = document.getElementById('userFilter');
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.full_name || user.username;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function loadLogs() {
            try {
                const skip = (currentPage - 1) * logsPerPage;
                const logs = await api.get(`/api/admin/logs?skip=${skip}&limit=${logsPerPage}`);
                allLogs = logs; // Store all logs for filtering
                const tbody = document.getElementById('logsTable');

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500 dark:text-slate-400">No logs found</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const actionColor = getActionColor(log.action_type);
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-slate-900 dark:text-white">${log.user_name || 'Unknown'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${actionColor}">
                                    ${log.action_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                                ${log.entity_type || '-'}
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
                                ${log.description}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                                ${Utils.formatTime(log.timestamp)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                                ${log.ip_address || '-'}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update pagination info
                document.getElementById('showingFrom').textContent = skip + 1;
                document.getElementById('showingTo').textContent = skip + logs.length;
                document.getElementById('totalLogs').textContent = totalLogs || logs.length;
                document.getElementById('currentPage').textContent = currentPage;

                // Update pagination buttons
                document.getElementById('prevPage').disabled = currentPage === 1;
                document.getElementById('nextPage').disabled = logs.length < logsPerPage;

            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('logsTable').innerHTML = 
                    '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load logs</td></tr>';
            }
        }

        function getActionColor(actionType) {
            if (actionType.includes('create')) return 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300';
            if (actionType.includes('update')) return 'text-blue-600 bg-blue-100 dark:bg-blue-900 dark:text-blue-300';
            if (actionType.includes('delete')) return 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300';
            if (actionType.includes('login')) return 'text-purple-600 bg-purple-100 dark:bg-purple-900 dark:text-purple-300';
            return 'text-slate-600 bg-slate-100 dark:bg-slate-700 dark:text-slate-400';
        }

        async function refreshLogs() {
            await loadLogs();
            Utils.showToast('Logs refreshed', 'success');
        }

        function exportLogs() {
            Utils.showToast('Export functionality coming soon', 'info');
        }

        function applyFilters() {
            const actionFilter = document.getElementById('actionFilter').value;
            const userFilter = document.getElementById('userFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            // Apply filters to current logs
            let filteredLogs = [...allLogs];
            
            if (actionFilter) {
                filteredLogs = filteredLogs.filter(log => 
                    log.action_type.toLowerCase().includes(actionFilter.toLowerCase())
                );
            }
            
            if (userFilter) {
                filteredLogs = filteredLogs.filter(log => 
                    log.user_id.toString() === userFilter
                );
            }
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filteredLogs = filteredLogs.filter(log => 
                    new Date(log.timestamp) >= fromDate
                );
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999); // End of day
                filteredLogs = filteredLogs.filter(log => 
                    new Date(log.timestamp) <= toDate
                );
            }
            
            renderFilteredLogs(filteredLogs);
        }

        function renderFilteredLogs(logs) {
            const tbody = document.getElementById('logsTable');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500 dark:text-slate-400">No logs found matching your filters</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const actionColor = getActionColor(log.action_type);
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">
                            ${log.user_name || 'Unknown'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${actionColor}">
                                ${log.action_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                            ${log.entity_type || '-'}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
                            ${log.description}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                            ${Utils.formatTime(log.timestamp)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                            ${log.ip_address || '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function clearFilters() {
            document.getElementById('actionFilter').value = '';
            document.getElementById('userFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1) {
                currentPage = newPage;
                loadLogs();
            }
        }

        function logout() {
            Auth.logout();
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
                document.getElementById('darkModeText').textContent = 'Dark Mode';
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
                document.getElementById('darkModeText').textContent = 'Light Mode';
            }
        }

        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
                document.getElementById('darkModeText').textContent = 'Light Mode';
            }
        }
    </script>
</body>
</html>