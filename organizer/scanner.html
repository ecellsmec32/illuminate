<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>QR Scanner - QrFlow</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        display: ["Inter"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }
        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        canvas {
            display: none;
        }
        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        .scanner-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 1rem;
            color: white;
        }
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 4px solid #137fec;
            border-radius: 1rem;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        .scanner-corners {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #137fec;
        }
        .scanner-corner.top-left {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }
        .scanner-corner.top-right {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
        }
        .scanner-corner.bottom-left {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
        }
        .scanner-corner.bottom-right {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }
        .scanner-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 1rem;
            color: white;
        }
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .result-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .scanning-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #137fec, transparent);
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(-140px); }
            100% { transform: translateY(140px); }
        }
        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 2px solid rgba(19, 127, 236, 0.3);
            border-radius: 1rem;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.1); opacity: 0; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="../assets/css/qrflow.css" rel="stylesheet"/>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
    <!-- Video Container -->
    <div id="videoContainer">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <!-- Scanner Overlay -->
    <div class="scanner-overlay">
        <!-- Header -->
        <div class="scanner-header">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="goBack()" class="p-2 bg-black/20 rounded-full hover:bg-black/40 transition-colors">
                        <span class="material-symbols-outlined text-white">arrow_back</span>
                    </button>
                    <div>
                        <h1 class="text-lg font-semibold text-white">QR Scanner</h1>
                        <p class="text-sm text-white/80" id="eventName">Select an event</p>
                        <p class="text-xs text-white/60" id="processedCount">No QR codes processed yet</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleFlash()" id="flashBtn" class="p-2 bg-black/20 rounded-full hover:bg-black/40 transition-colors">
                        <span class="material-symbols-outlined text-white">flash_off</span>
                    </button>
                    <button onclick="toggleDarkMode()" class="p-2 bg-black/20 rounded-full hover:bg-black/40 transition-colors">
                        <span class="material-symbols-outlined text-white" id="darkModeIcon">dark_mode</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Scanner Frame -->
        <div class="scanner-frame">
            <div class="pulse-ring"></div>
            <div class="scanning-line"></div>
            <div class="scanner-corners">
                <div class="scanner-corner top-left"></div>
                <div class="scanner-corner top-right"></div>
                <div class="scanner-corner bottom-left"></div>
                <div class="scanner-corner bottom-right"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="scanner-footer">
            <div class="text-center">
                <p class="text-white/80 mb-4">Position QR code within the frame</p>
                <div class="flex justify-center gap-4">
                    <button onclick="selectEvent()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Select Event
                    </button>
                    <button onclick="manualCheckin()" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30">
                        Manual Check-in
                    </button>
                    <button onclick="clearProcessedQRCodes()" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30">
                        Clear History
                    </button>
                    <button onclick="showQRViewer()" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30">
                        View QR Codes
                    </button>
                    <button onclick="generateTestQR()" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30">
                        Test QR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Selection Modal -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-background-dark rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Select Event</h3>
                <button onclick="hideEventModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <select id="eventSelector" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white mb-4">
                <option value="">Choose an event...</option>
            </select>
            <div class="flex gap-3">
                <button onclick="startScanning()" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90">
                    Start Scanning
                </button>
                <button onclick="hideEventModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Check-in Modal -->
    <div id="manualModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-background-dark rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Manual Check-in</h3>
                <button onclick="hideManualModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <input type="text" id="manualInput" placeholder="Enter roll number..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white mb-4">
            <div class="flex gap-3">
                <button onclick="performManualCheckin()" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90">
                    Check In
                </button>
                <button onclick="hideManualModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="result-modal">
        <div class="result-content">
            <div id="resultIcon" class="text-6xl mb-4">✅</div>
            <h3 id="resultTitle" class="text-xl font-bold mb-2">Check-in Successful</h3>
            <p id="resultMessage" class="text-slate-600 mb-4">Attendee has been checked in</p>
            <button onclick="closeResultModal()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                Continue Scanning
            </button>
        </div>
    </div>

    <!-- QR Viewer Modal -->
    <div id="qrViewerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-background-dark rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">QR Codes for Event</h3>
                <button onclick="hideQRViewer()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="qrCodesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- QR codes will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/message-display.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        // Check authentication
        Auth.requireAuth();
        const user = Auth.getCurrentUser();
        
        if (user.role !== 'organizer') {
            Utils.showToast('Access denied - Club organizer only', 'error');
            setTimeout(() => window.location.href = '../index.html', 2000);
        }

        let currentEventId = null;
        let stream = null;
        let scanning = false;
        let scanInterval = null;
        let lastScanTime = 0;
        let processedQRCodes = new Set(); // Track processed QR codes
        const SCAN_COOLDOWN = 1000; // 1 second cooldown between scans

        // Initialize scanner
        document.addEventListener('DOMContentLoaded', async () => {
            initDarkMode();
            await loadEvents();
            selectEvent();
        });

        async function loadEvents() {
            try {
                const events = await api.get('/api/club/events');
                const eventSelector = document.getElementById('eventSelector');
                
                eventSelector.innerHTML = '<option value="">Choose an event...</option>';
                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} - ${new Date(event.date).toLocaleDateString()}`;
                    eventSelector.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load events:', error);
                Utils.showToast('Failed to load events', 'error');
            }
        }

        function selectEvent() {
            document.getElementById('eventModal').classList.remove('hidden');
            document.getElementById('eventModal').classList.add('flex');
        }

        function hideEventModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.getElementById('eventModal').classList.remove('flex');
        }

        function manualCheckin() {
            if (!currentEventId) {
                Utils.showToast('Please select an event first', 'warning');
                return;
            }
            document.getElementById('manualModal').classList.remove('hidden');
            document.getElementById('manualModal').classList.add('flex');
        }

        function hideManualModal() {
            document.getElementById('manualModal').classList.add('hidden');
            document.getElementById('manualModal').classList.remove('flex');
        }

        async function startScanning() {
            const eventId = document.getElementById('eventSelector').value;
            if (!eventId) {
                Utils.showToast('Please select an event', 'warning');
                return;
            }

            currentEventId = eventId;
            const eventName = document.getElementById('eventSelector').selectedOptions[0].textContent;
            document.getElementById('eventName').textContent = eventName;
            
            // Clear processed QR codes for new event
            processedQRCodes.clear();
            updateProcessedCount();
            
            // Generate QR codes for the event if they don't exist
            try {
                await api.post(`/api/events/${eventId}/generate-qr`);
                Utils.showToast('QR codes generated for this event', 'success');
            } catch (error) {
                console.log('QR codes may already exist or generation failed:', error);
            }
            
            hideEventModal();
            await startCamera();
        }

        async function startCamera() {
            try {
                // Stop any existing stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // Reset scanning state
                scanning = false;

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    video.play();
                    scanning = true;
                    startQRScanning();
                };
                
            } catch (error) {
                console.error('Failed to start camera:', error);
                Utils.showToast('Failed to access camera. Please check permissions.', 'error');
            }
        }

        function startQRScanning() {
            if (!scanning) return;

            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            function scanFrame() {
                if (!scanning) return;

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        const now = Date.now();
                        if (now - lastScanTime > SCAN_COOLDOWN) {
                            lastScanTime = now;
                            handleQRCode(code.data);
                        }
                    }
                }
                
                requestAnimationFrame(scanFrame);
            }

            scanFrame();
        }

        async function handleQRCode(qrData) {
            scanning = false;
            
            try {
                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // Check if this QR code was already processed in this session
                if (processedQRCodes.has(qrData)) {
                    console.log('QR code already processed in this session:', qrData);
                    MessageDisplay.showResultModal('⚠️ This QR code has already been processed in this session.\n\nPlease use a different QR code or restart the scanner.');
                    return;
                }

                // Add to processed QR codes set
                processedQRCodes.add(qrData);
                updateProcessedCount();

                // Show loading state
                MessageDisplay.showLoading('Validating QR code...');

                // Optional: Pre-validate QR token
                try {
                    const validateResponse = await api.validateQRToken(qrData);
                    
                    if (!validateResponse.success) {
                        MessageDisplay.showResultModal(validateResponse.message);
                        return;
                    }

                    // If already checked in, show info message
                    if (validateResponse.already_checked_in) {
                        MessageDisplay.showResultModal(validateResponse.message);
                        return;
                    }

                    // Update loading message
                    MessageDisplay.showLoading('Processing check-in...');

                } catch (validateError) {
                    console.log('Pre-validation failed, proceeding with direct check-in:', validateError);
                    // Continue with direct check-in if validation fails
                }

                // Process QR code for check-in
                const result = await api.scanQRCheckin(qrData);
                
                // Show result using enhanced message display
                MessageDisplay.showResultModal(result.message);
                
            } catch (error) {
                console.error('QR scan failed:', error);
                
                // Remove from processed set if check-in failed
                processedQRCodes.delete(qrData);
                updateProcessedCount();
                
                // Handle error with enhanced message display
                const errorMessage = MessageDisplay.handleApiError(error);
                MessageDisplay.showResultModal(errorMessage);
            }
        }

        function showDuplicateVerification(data) {
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            
            icon.textContent = '⚠️';
            icon.className = 'text-6xl mb-4 text-yellow-500';
            title.textContent = 'Duplicate Pass Detected';
            message.textContent = `Multiple passes found for ${data.attendee_name}. Please verify which pass to use.`;
            
            modal.style.display = 'flex';
        }

        function showResult(type, title, message) {
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const titleEl = document.getElementById('resultTitle');
            const messageEl = document.getElementById('resultMessage');
            
            if (type === 'success') {
                icon.textContent = '✅';
                icon.className = 'text-6xl mb-4 text-green-500';
            } else {
                icon.textContent = '❌';
                icon.className = 'text-6xl mb-4 text-red-500';
            }
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            modal.style.display = 'flex';
        }

        function closeResultModal() {
            MessageDisplay.hideResultModal();
            // Restart scanning
            setTimeout(() => {
                startCamera();
            }, 500);
        }

        async function performManualCheckin() {
            const rollNumber = document.getElementById('manualInput').value.trim();
            if (!rollNumber || !currentEventId) {
                Utils.showToast('Please enter roll number', 'warning');
                return;
            }

            try {
                // Search for attendee by roll number only
                const attendees = await api.get(`/api/events/${currentEventId}/attendees`);
                const attendee = attendees.find(a => 
                    a.roll_number.toLowerCase() === rollNumber.toLowerCase()
                );

                if (!attendee) {
                    Utils.showToast('Attendee not found with this roll number', 'error');
                    return;
                }

                if (attendee.checked_in) {
                    Utils.showToast(`${attendee.name} is already checked in`, 'warning');
                    return;
                }

                // Check for duplicate passes
                const duplicatePasses = attendees.filter(a => 
                    a.roll_number.toLowerCase() === rollNumber.toLowerCase() && a.id !== attendee.id
                );

                if (duplicatePasses.length > 0) {
                    showDuplicatePassModal(attendee, duplicatePasses);
                    return;
                }

                // Perform manual check-in
                const result = await api.manualCheckin(attendee.id);
                
                hideManualModal();
                
                // Show result using enhanced message display
                if (result.message) {
                    MessageDisplay.showResultModal(result.message);
                } else {
                    MessageDisplay.showResultModal(`✅ Manual check-in successful!\n\n👤 Name: ${attendee.name}\n🎓 Roll Number: ${attendee.roll_number}`);
                }
                
            } catch (error) {
                console.error('Manual check-in failed:', error);
                
                // Handle error with enhanced message display
                const errorMessage = MessageDisplay.handleApiError(error);
                hideManualModal();
                MessageDisplay.showResultModal(errorMessage);
            }
        }

        // Add global functions for modal interactions
        window.verifyDuplicatePass = verifyDuplicatePass;
        window.closeDuplicateModal = closeDuplicateModal;

        function showQRViewer() {
            if (!currentEventId) {
                Utils.showToast('Please select an event first', 'warning');
                return;
            }
            document.getElementById('qrViewerModal').classList.remove('hidden');
            document.getElementById('qrViewerModal').classList.add('flex');
            loadQRCodes();
        }

        function hideQRViewer() {
            document.getElementById('qrViewerModal').classList.add('hidden');
            document.getElementById('qrViewerModal').classList.remove('flex');
        }

        function generateTestQR() {
            if (!currentEventId) {
                Utils.showToast('Please select an event first', 'warning');
                return;
            }
            
            // Create a test QR code for testing
            const testQRData = `test_qr_${currentEventId}_${Date.now()}`;
            Utils.showToast(`Test QR Code: ${testQRData}`, 'info');
            
            // Simulate QR code detection for testing
            setTimeout(() => {
                handleQRCode(testQRData);
            }, 1000);
        }

        function clearProcessedQRCodes() {
            const count = processedQRCodes.size;
            processedQRCodes.clear();
            updateProcessedCount();
            
            if (count > 0) {
                Utils.showToast(`Cleared ${count} processed QR codes. You can now scan the same QR codes again.`, 'success');
            } else {
                Utils.showToast('No processed QR codes to clear.', 'info');
            }
        }

        function updateProcessedCount() {
            const count = processedQRCodes.size;
            const countElement = document.getElementById('processedCount');
            
            if (count === 0) {
                countElement.textContent = 'No QR codes processed yet';
            } else {
                countElement.textContent = `${count} QR code${count === 1 ? '' : 's'} processed`;
            }
        }

        async function loadQRCodes() {
            try {
                const attendees = await api.get(`/api/events/${currentEventId}/attendees`);
                const container = document.getElementById('qrCodesContainer');
                
                if (attendees.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center text-slate-500 dark:text-slate-400 py-8">No attendees found for this event</div>';
                    return;
                }

                container.innerHTML = attendees.map(attendee => `
                    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4 text-center">
                        <div class="mb-2">
                            <div class="font-medium text-slate-900 dark:text-white">${attendee.name}</div>
                            <div class="text-sm text-slate-500 dark:text-slate-400">${attendee.roll_number}</div>
                        </div>
                        <div class="mb-2">
                            <div class="w-32 h-32 mx-auto bg-slate-100 dark:bg-slate-700 rounded flex items-center justify-center">
                                <span class="text-xs text-slate-500">QR Code</span>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">
                            ${attendee.checked_in ? '✅ Checked In' : '⏳ Pending'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load QR codes:', error);
                document.getElementById('qrCodesContainer').innerHTML = 
                    '<div class="col-span-full text-center text-red-500 py-8">Failed to load QR codes</div>';
            }
        }

        function showDuplicatePassModal(attendee, duplicates) {
            // Create duplicate pass verification modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-background-dark rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Duplicate Passes Found</h3>
                    <p class="text-slate-600 dark:text-slate-400 mb-4">
                        Multiple passes found for ${attendee.name} (${attendee.roll_number}). Please select which pass to use:
                    </p>
                    <div class="space-y-2 mb-4">
                        <label class="flex items-center p-3 border border-slate-200 dark:border-slate-700 rounded-lg">
                            <input type="radio" name="passSelection" value="${attendee.id}" checked class="mr-3">
                            <div>
                                <div class="font-medium">${attendee.name}</div>
                                <div class="text-sm text-slate-500">${attendee.email}</div>
                            </div>
                        </label>
                        ${duplicates.map(dup => `
                            <label class="flex items-center p-3 border border-slate-200 dark:border-slate-700 rounded-lg">
                                <input type="radio" name="passSelection" value="${dup.id}" class="mr-3">
                                <div>
                                    <div class="font-medium">${dup.name}</div>
                                    <div class="text-sm text-slate-500">${dup.email}</div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex gap-3">
                        <button onclick="verifyDuplicatePass()" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90">
                            Verify & Check In
                        </button>
                        <button onclick="closeDuplicateModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function verifyDuplicatePass() {
            const selectedPass = document.querySelector('input[name="passSelection"]:checked');
            if (!selectedPass) {
                Utils.showToast('Please select a pass', 'warning');
                return;
            }

            try {
                const result = await api.manualCheckin(selectedPass.value);
                closeDuplicateModal();
                hideManualModal();
                
                // Show result using enhanced message display
                if (result.message) {
                    MessageDisplay.showResultModal(result.message);
                } else {
                    MessageDisplay.showResultModal('✅ Check-in Successful\n\nAttendee has been checked in successfully');
                }
            } catch (error) {
                console.error('Duplicate pass verification failed:', error);
                const errorMessage = MessageDisplay.handleApiError(error);
                MessageDisplay.showResultModal(errorMessage);
            }
        }

        function closeDuplicateModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        function toggleFlash() {
            // Flash toggle functionality would go here
            Utils.showToast('Flash toggle coming soon', 'info');
        }

        function goBack() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            window.location.href = 'dashboard.html';
        }

        function logout() {
            Auth.logout();
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
            }
        }

        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>